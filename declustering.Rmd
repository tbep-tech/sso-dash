---
output: 
  html_document
self_contained: yes
---
  
```{r setup, message = F, warning = F, results = 'hide', echo = F}
knitr::opts_chunk$set(echo = T, warning = F, message = F, fig.path = 'figs/', dev.args = list(family = 'serif'))
```

# Declustering

## Import and format data

```{r, message = F, warning = F}
library(tidyverse)
library(here)
library(lubridate)
library(ggExtra)
library(extRemes)

# import data
indvar0 <- read.csv(here::here('data/data-raw/LR_final_indvar0.csv'), stringsAsFactors = F)

# rename and format date
dat <- indvar0 %>% 
  select(
    date = stime0,
    precp = `indvar0...1.`,
    water = `indvar0...3.`
  ) %>% 
  mutate(date = dmy(date))
```

## Subset by values > 5  sd for precipitation

```{r}
sdup <- 5
subdat <- dat %>% 
  mutate(
    fltval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T)
  ) %>%
  filter(precp > fltval) 
```

## Create marginal plots of water and precip

```{r, fig.height = 5, fig.width = 5}
p <- ggplot(subdat, aes(x = water, y = precp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = expression(paste(P[2] > 5, sigma))
  )

ggMarginal(p, type = 'histogram', size = 2)
```

## Declustering precip only {.tabset}

### > 3 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 3
dcldat <- dat %>% 
  mutate(
    fltval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(fltval))
  )

p <- ggplot(dcldat, aes(x = water, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### > 4 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 4
dcldat <- dat %>% 
  mutate(
    fltval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(fltval))
  )

p <- ggplot(dcldat, aes(x = water, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### > 5 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 5
dcldat <- dat %>% 
  mutate(
    fltval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(fltval))
  )

p <- ggplot(dcldat, aes(x = water, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### None

```{r, fig.height = 5, fig.width = 5}
p <- ggplot(dat, aes(x = water, y = precp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = 'No declustering'
  )

ggMarginal(p, type = 'histogram', size = 2)
```

## Declustering precip and water {.tabset}

### > 3 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 3
dcldat <- dat %>% 
  mutate(
    prcval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(prcval)),    
    wtrval = mean(water, na.rm = T) + sdup * sd(water, na.rm = T),
    dclwater = decluster(water, unique(wtrval))
  )

p <- ggplot(dcldat, aes(x = dclwater, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### > 4 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 4
dcldat <- dat %>% 
  mutate(
    prcval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(prcval)),    
    wtrval = mean(water, na.rm = T) + sdup * sd(water, na.rm = T),
    dclwater = decluster(water, unique(wtrval))
  )

p <- ggplot(dcldat, aes(x = dclwater, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### > 5 sd

```{r, fig.height = 5, fig.width = 5}
sdup <- 5
dcldat <- dat %>% 
  mutate(
    prcval = mean(precp, na.rm = T) + sdup * sd(precp, na.rm = T),
    dclprecp = decluster(precp, unique(prcval)),    
    wtrval = mean(water, na.rm = T) + sdup * sd(water, na.rm = T),
    dclwater = decluster(water, unique(wtrval))
  )

p <- ggplot(dcldat, aes(x = dclwater, y = dclprecp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = bquote('Values >'~.(sdup)*sigma~'declustered')
  )

ggMarginal(p, type = 'histogram', size = 2)
```

### None

```{r, fig.height = 5, fig.width = 5}
p <- ggplot(dat, aes(x = water, y = precp)) +
  geom_path(color = 'grey') + 
  geom_point(size = 2) + 
  theme_bw() + 
  theme(
    panel.grid = element_blank()
  ) +
  labs(
    x = expression(paste(W[2], ' (m, MLLW)')), 
    y = expression(paste(P[2], ' (cm)')), 
    title = 'No declustering'
  )

ggMarginal(p, type = 'histogram', size = 2)
```